<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ë‹¹ê·¼ ìˆ˜í•™ ê²Œì„ - ê²Œì„</title>
    <style>
        @font-face {
            font-family: 'Cafe24Ssurround';
            src: url('assets/fonts/Cafe24Ssurround-v2.0.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'Cafe24Ssurround', system-ui, sans-serif;
        }

        .container {
            position: relative;
            width: 100%;
            height: 100dvh;
            height: 100vh; /* fallback */
            background-color: #FFF8F0;
            overflow: hidden;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* ëª¨ë“  ì´ë¯¸ì§€ ë ˆì´ì–´ ë™ì¼í•œ cover ë°©ì‹ìœ¼ë¡œ ì •ë ¬ */
        .layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center center;
            pointer-events: none;
        }

        #basketLayer {
            transform: translateY(5%);
        }

        /* ë’¤ë¡œê°€ê¸° ë²„íŠ¼ */
        .back-button {
            position: absolute;
            top: 50px;
            right: 20px;
            width: 44px;
            height: 44px;
            border-radius: 22px;
            background: rgba(255, 255, 255, 0.85);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 100;
            font-size: 22px;
            color: #3D2817;
        }

        /* ì§„í–‰ ìƒíƒœ */
        .progress-container {
            position: absolute;
            top: 50px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            padding: 8px 14px;
            min-width: 70px;
            text-align: center;
            z-index: 100;
        }

        .progress-text {
            font-size: 20px;
            font-weight: 900;
            color: #3D2817;
        }

        /* ë°”êµ¬ë‹ˆ + ìˆ«ì ì „ì²´ í´ë¦­ ì˜ì—­ */
        .basket-button {
            position: absolute;
            top: 14%;
            width: 40%;
            height: 34%;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding-top: 2%;
            background: none;
            border: none;
            cursor: pointer;
            pointer-events: auto;
            transform: translateX(-50%);
            z-index: 40;
            transition: opacity 0.2s;
        }

        #basketBtn1 {
            left: 25%;
        }

        #basketBtn2 {
            left: 75%;
        }

        .basket-button:active {
            transform: translateX(-50%) scale(0.95);
        }

        .basket-button.selected {
            opacity: 0.4;
            pointer-events: none;
        }

        .basket-button.disabled {
            pointer-events: none;
        }

        .basket-number {
            font-size: clamp(32px, min(11vw, 7vh), 60px);
            font-weight: 900;
            color: #3D2817;
            text-shadow: 0 2px 4px rgba(255,255,255,0.5);
            user-select: none;
        }

        /* ìˆ˜í•™ ë¬¸ì œ - ë°”êµ¬ë‹ˆ ì•„ë˜, ë¹›ë‚˜ëŠ” ì˜ì—­ */
        .question-container {
            position: absolute;
            top: 48%;
            left: 5%;
            right: 5%;
            text-align: center;
            z-index: 50;
        }

        .question-text {
            font-size: clamp(32px, min(11vw, 7vh), 60px);
            font-weight: 900;
            color: #FF6B35;
            text-shadow: 0 2px 6px rgba(255,255,255,0.6);
        }

        /* í† ë¼ ê°ì • ì´ë¯¸ì§€ */
        .rabbit-layer {
            position: absolute;
            bottom: 3%;
            left: 0%;
            width: 85%;
            height: 68%;
            pointer-events: none;
            z-index: 30;
        }

        .rabbit-img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: left center;
            opacity: 0;
        }

        .rabbit-img.active {
            opacity: 1;
        }

        /* ì •ë‹µ/ì˜¤ë‹µ ì´í™íŠ¸ */
        .result-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
            pointer-events: none;
        }

        .result-overlay.show {
            display: flex;
        }

        .result-emoji {
            font-size: 120px;
            animation: resultPop 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes resultPop {
            0% { transform: scale(0); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* ì²« ì˜¤ë‹µ ê²©ë ¤ ìš”ì†Œë“¤ (ê°™ì€ í™”ë©´ì—ì„œ í‘œì‹œ) */
        .encourage-text {
            position: absolute;
            top: 22%;
            left: 5%;
            right: 5%;
            text-align: center;
            z-index: 60;
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.4s ease, transform 0.4s ease;
            pointer-events: none;
        }

        .encourage-text.show {
            opacity: 1;
            transform: translateY(0);
        }

        .encourage-line {
            display: block;
            font-size: clamp(20px, min(7vw, 4.5vh), 38px);
            font-weight: 900;
            color: #FF6B35;
            text-shadow: 0 2px 4px rgba(255,255,255,0.8);
            margin-bottom: 12px;
        }

        .encourage-line:nth-child(2) {
            margin-bottom: 20px;
        }

        .encourage-mom {
            position: absolute;
            right: -20%;
            bottom: -5%;
            width: 80%;
            height: 70%;
            z-index: 35;
            opacity: 0;
            transition: opacity 0.4s ease;
            pointer-events: none;
        }

        .encourage-mom.show {
            opacity: 1;
        }

        .encourage-mom img {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: contain;
            object-position: center bottom;
            opacity: 0;
        }

        .encourage-mom img.active {
            opacity: 1;
        }

        /* ì—„ë§ˆí† ë¼ frame2 ìœ„ì¹˜ ë³´ì • (ì…ë§Œ ì›€ì§ì´ë„ë¡) */
        #encourageMomFrame1 {
            transform: translateX(1.2%);
        }

        /* ìˆ¨ê¹€ ì²˜ë¦¬ìš© */
        .game-element {
            transition: opacity 0.3s ease;
        }

        .game-element.hidden {
            opacity: 0;
            pointer-events: none;
        }

        /* ë‹¤ì‹œ ë„ì „ ë²„íŠ¼ */
        .retry-button {
            position: absolute;
            bottom: 8%;
            left: 50%;
            transform: translateX(-50%);
            padding: 14px 32px;
            background: #FF6B35;
            color: white;
            border: none;
            border-radius: 30px;
            font-size: 20px;
            font-weight: 900;
            font-family: 'Cafe24Ssurround', system-ui, sans-serif;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease, transform 0.1s;
        }

        .retry-button.show {
            opacity: 1;
            pointer-events: auto;
        }

        .retry-button:active {
            transform: translateX(-50%) scale(0.95);
        }

        /* ì™„ë£Œ í™”ë©´ */
        .finish-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 248, 240, 0.95);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 300;
            gap: 20px;
        }

        .finish-overlay.show {
            display: flex;
        }

        .finish-emoji {
            font-size: 80px;
            animation: bounce 1s ease-in-out infinite;
        }

        .finish-text {
            font-size: 32px;
            font-weight: 900;
            color: #FF6B35;
            text-align: center;
        }

        .finish-sub {
            font-size: 18px;
            color: #3D2817;
            margin-top: 8px;
        }

        .restart-button {
            margin-top: 20px;
            padding: 16px 40px;
            background: #FF6B35;
            color: white;
            border: none;
            border-radius: 30px;
            font-size: 22px;
            font-weight: 900;
            font-family: 'Cafe24Ssurround', system-ui, sans-serif;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
            transition: transform 0.1s;
        }

        .restart-button:active {
            transform: scale(0.95);
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        /* PC ëŒ€ì‘ */
        @media (min-width: 769px) {
            .container {
                max-width: 480px;
                margin: 0 auto;
            }

            #basketLayer {
                transform: translateY(5%) scale(0.85);
            }

            #basketBtn1 {
                left: 30%;
            }

            #basketBtn2 {
                left: 70%;
            }

            .encourage-text {
                top: 20%;
            }

            .rabbit-layer {
                bottom: 0%;
                left: 5%;
                width: 110%;
                height: 90%;
            }

            .rabbit-img {
                object-fit: contain;
                object-position: left bottom;
            }

            .encourage-mom {
                right: -15%;
                bottom: -5%;
                width: 75%;
                height: 65%;
            }
        }

        /* ì„¸ë¡œë¡œ ê¸´ í™”ë©´ (20:9 ë“±) */
        @media (max-aspect-ratio: 9/18) {
            .progress-container {
                top: calc(40px + env(safe-area-inset-top));
            }
            .back-button {
                top: calc(40px + env(safe-area-inset-top));
            }
            .basket-button {
                top: 12%;
                height: 28%;
            }
            .basket-number {
                font-size: clamp(28px, min(9vw, 5vh), 48px);
            }
            .question-container {
                top: 42%;
            }
            .question-text {
                font-size: clamp(28px, min(9vw, 5vh), 48px);
            }
            .rabbit-layer {
                bottom: 5%;
                height: 55%;
            }
            .encourage-text {
                top: 18%;
            }
            .encourage-line {
                font-size: clamp(18px, min(6vw, 3.5vh), 30px);
            }
            .encourage-mom {
                bottom: 0%;
                height: 55%;
            }
            .retry-button {
                bottom: 10%;
                font-size: 16px;
                padding: 12px 28px;
            }
        }

        /* ì§§ì€ í™”ë©´ (íƒœë¸”ë¦¿ ë“±) */
        @media (min-aspect-ratio: 3/4) {
            .basket-button {
                top: 16%;
                height: 38%;
            }
            .question-container {
                top: 52%;
            }
            .rabbit-layer {
                bottom: -5%;
                height: 75%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ë ˆì´ì–´ 1: ë°°ê²½ -->
        <img class="layer" src="assets/game/2_game_background.png" alt="ë°°ê²½" style="z-index:1;">

        <!-- ë ˆì´ì–´ 2: ë‹¹ê·¼ ë°”êµ¬ë‹ˆ (ì•½ê°„ ì•„ë˜ë¡œ ì´ë™) -->
        <img class="layer game-element" id="basketLayer" src="assets/game/2_game_carrot_basket_empty.png" alt="ë°”êµ¬ë‹ˆ" style="z-index:2;">

        <!-- ë ˆì´ì–´ 3: í† ë¼ ìºë¦­í„° (ê°ì •ë³„) -->
        <div class="rabbit-layer">
            <img class="rabbit-img active" id="rabbitCurious" src="assets/game/2_game_baby_rabbit_curious.png" alt="ê¶ê¸ˆí•œ í† ë¼">
            <img class="rabbit-img" id="rabbitHappy" src="assets/game/2_game_baby_rabbit_happy.png" alt="í–‰ë³µí•œ í† ë¼">
            <img class="rabbit-img" id="rabbitSad" src="assets/game/2_game_baby_rabbit_sad.png" alt="ìŠ¬í”ˆ í† ë¼">
        </div>

        <!-- UI: ë’¤ë¡œê°€ê¸° -->
        <button class="back-button" onclick="location.href='story.html';">&#8592;</button>

        <!-- UI: ì§„í–‰ ìƒíƒœ -->
        <div class="progress-container">
            <span class="progress-text" id="progressText">1 / 5</span>
        </div>

        <!-- UI: ë°”êµ¬ë‹ˆ ìœ„ ìˆ«ì ì„ íƒ (ê° ë°”êµ¬ë‹ˆ ì¤‘ì•™ ìœ„) -->
        <button class="basket-button game-element" id="basketBtn1" onclick="handleBasketPress(0)">
            <span class="basket-number" id="basketNum1"></span>
        </button>
        <button class="basket-button game-element" id="basketBtn2" onclick="handleBasketPress(1)">
            <span class="basket-number" id="basketNum2"></span>
        </button>

        <!-- UI: ìˆ˜í•™ ë¬¸ì œ -->
        <div class="question-container game-element" id="questionContainer">
            <span class="question-text" id="questionText"></span>
        </div>

        <!-- ì •ë‹µ/ì˜¤ë‹µ ì´í™íŠ¸ -->
        <div class="result-overlay" id="resultOverlay">
            <span class="result-emoji" id="resultEmoji"></span>
        </div>

        <!-- ì²« ì˜¤ë‹µ ê²©ë ¤ ìš”ì†Œë“¤ -->
        <div class="encourage-text" id="encourageText">
            <span class="encourage-line">í‹€ë ¤ë„ ê´œì°®ì•„,</span>
            <span class="encourage-line">ì—„ë§ˆëŠ” ê¸°ë‹¤ë¦´ê²Œ !</span>
            <span class="encourage-line">ë‹¤ì‹œ í•œë²ˆ ìƒê°í•´ë³´ì !</span>
        </div>
        <div class="encourage-mom" id="encourageMom">
            <img id="encourageMomFrame0" class="active" src="assets/game/1_intro_mom_rabbit_talking_1.png" alt="ì—„ë§ˆí† ë¼1">
            <img id="encourageMomFrame1" src="assets/game/1_intro_mom_rabbit_talking_2.png" alt="ì—„ë§ˆí† ë¼2">
        </div>
        <button class="retry-button" id="retryButton" onclick="handleRetry()">ë„¤, ë‹¤ì‹œ ë„ì „!</button>

        <!-- ì™„ë£Œ í™”ë©´ -->
        <div class="finish-overlay" id="finishOverlay">
            <span class="finish-emoji">ğŸ‰</span>
            <span class="finish-text">ëŒ€ë‹¨í•´! ë‹¤ ë§í˜”ì–´!</span>
            <span class="finish-sub">ë‹¹ê·¼ì„ ëª¨ë‘ ëª¨ì•˜ì–´ìš”</span>
            <button class="restart-button" onclick="location.href='index.html';">ë‹¤ì‹œ í•˜ê¸°</button>
        </div>
    </div>

    <script>
        let currentQuestion = null;
        let selectedBasket = null;
        let correctCount = 0;
        let firstWrongShown = false;
        let encourageMomInterval = null;
        const TOTAL_QUESTIONS = 10;

        function shuffleArray(array) {
            return [...array].sort(() => Math.random() - 0.5);
        }

        function generateBaskets(answer) {
            const offset = Math.floor(Math.random() * 3) + 1;
            let wrongAnswer = Math.random() > 0.5
                ? answer + offset
                : Math.max(0, answer - offset);

            // ë™ì¼ ìˆ«ì ë°©ì§€
            if (wrongAnswer === answer) {
                wrongAnswer = answer + offset;
            }

            return shuffleArray([answer, wrongAnswer]);
        }

        function generateQuestion() {
            const type = Math.floor(Math.random() * 3);

            if (type === 0) {
                const ones = Math.floor(Math.random() * 10);
                const tens = [10, 20, 30][Math.floor(Math.random() * 3)];
                const operation = Math.random() > 0.5 ? '+' : '-';
                let answer, a, b;
                if (operation === '+') {
                    a = ones; b = tens; answer = ones + tens;
                } else {
                    answer = Math.floor(Math.random() * 10);
                    a = answer + tens; b = tens;
                }
                return { text: a + ' ' + operation + ' ' + b + ' = ?', answer: answer, baskets: generateBaskets(answer) };
            }

            if (type === 1) {
                const tens1 = [10, 20, 30, 40][Math.floor(Math.random() * 4)];
                const tens2 = [10, 20][Math.floor(Math.random() * 2)];
                const operation = Math.random() > 0.5 ? '+' : '-';
                let answer, a, b;
                if (operation === '+') {
                    a = tens1; b = tens2; answer = tens1 + tens2;
                } else {
                    a = Math.max(tens1, tens2); b = Math.min(tens1, tens2); answer = a - b;
                }
                return { text: a + ' ' + operation + ' ' + b + ' = ?', answer: answer, baskets: generateBaskets(answer) };
            }

            const isMultiply = Math.random() > 0.5;
            if (isMultiply) {
                const a = Math.floor(Math.random() * 3) + 1;
                const b = Math.floor(Math.random() * 3) + 1;
                const answer = a * b;
                return { text: a + ' \u00D7 ' + b + ' = ?', answer: answer, baskets: generateBaskets(answer) };
            } else {
                const divisors = [2, 3];
                const divisor = divisors[Math.floor(Math.random() * divisors.length)];
                const answer = Math.floor(Math.random() * 3) + 1;
                const a = answer * divisor;
                return { text: a + ' \u00F7 ' + divisor + ' = ?', answer: answer, baskets: generateBaskets(answer) };
            }
        }

        function setRabbitEmotion(emotion) {
            document.getElementById('rabbitCurious').classList.toggle('active', emotion === 'curious');
            document.getElementById('rabbitHappy').classList.toggle('active', emotion === 'happy');
            document.getElementById('rabbitSad').classList.toggle('active', emotion === 'sad');
        }

        function showResult(isCorrect) {
            const overlay = document.getElementById('resultOverlay');
            const emoji = document.getElementById('resultEmoji');
            emoji.textContent = isCorrect ? '\u2B55' : '\u274C';
            overlay.classList.add('show');
            setTimeout(() => overlay.classList.remove('show'), 800);
        }

        function showEncourageOverlay() {
            const btn1 = document.getElementById('basketBtn1');
            const btn2 = document.getElementById('basketBtn2');
            const questionContainer = document.getElementById('questionContainer');
            const basketLayer = document.getElementById('basketLayer');
            const encourageText = document.getElementById('encourageText');
            const encourageMom = document.getElementById('encourageMom');
            const retryButton = document.getElementById('retryButton');

            // ê²Œì„ ìš”ì†Œ ìˆ¨ê¸°ê¸°
            btn1.classList.add('hidden');
            btn2.classList.add('hidden');
            questionContainer.classList.add('hidden');
            basketLayer.classList.add('hidden');

            // ê²©ë ¤ ìš”ì†Œ ë³´ì´ê¸°
            encourageText.classList.add('show');
            encourageMom.classList.add('show');

            // 2ì´ˆ í›„ ë²„íŠ¼ ë³´ì´ê¸°
            setTimeout(() => {
                retryButton.classList.add('show');
            }, 2000);

            // ì—„ë§ˆí† ë¼ ë§í•˜ê¸° ì• ë‹ˆë©”ì´ì…˜
            let momFrame = 0;
            const f0 = document.getElementById('encourageMomFrame0');
            const f1 = document.getElementById('encourageMomFrame1');
            encourageMomInterval = setInterval(() => {
                momFrame = momFrame === 0 ? 1 : 0;
                f0.classList.toggle('active', momFrame === 0);
                f1.classList.toggle('active', momFrame === 1);
            }, 400);
        }

        function handleRetry() {
            const btn1 = document.getElementById('basketBtn1');
            const btn2 = document.getElementById('basketBtn2');
            const questionContainer = document.getElementById('questionContainer');
            const basketLayer = document.getElementById('basketLayer');
            const encourageText = document.getElementById('encourageText');
            const encourageMom = document.getElementById('encourageMom');
            const retryButton = document.getElementById('retryButton');

            // ì• ë‹ˆë©”ì´ì…˜ ì¤‘ì§€
            if (encourageMomInterval) {
                clearInterval(encourageMomInterval);
                encourageMomInterval = null;
            }

            // ê²©ë ¤ ìš”ì†Œ ìˆ¨ê¸°ê¸°
            encourageText.classList.remove('show');
            encourageMom.classList.remove('show');
            retryButton.classList.remove('show');

            // ê²Œì„ ìš”ì†Œ ë‹¤ì‹œ ë³´ì´ê¸°
            btn1.classList.remove('hidden', 'selected', 'disabled');
            btn2.classList.remove('hidden', 'selected', 'disabled');
            questionContainer.classList.remove('hidden');
            basketLayer.classList.remove('hidden');

            selectedBasket = null;
            setRabbitEmotion('curious');
        }

        function updateUI() {
            document.getElementById('questionText').textContent = currentQuestion.text;
            document.getElementById('basketNum1').textContent = currentQuestion.baskets[0];
            document.getElementById('basketNum2').textContent = currentQuestion.baskets[1];
            document.getElementById('progressText').textContent = (correctCount + 1) + ' / ' + TOTAL_QUESTIONS;
            const btn1 = document.getElementById('basketBtn1');
            const btn2 = document.getElementById('basketBtn2');
            btn1.classList.remove('selected', 'disabled');
            btn2.classList.remove('selected', 'disabled');
        }

        function handleBasketPress(index) {
            if (selectedBasket !== null) return;
            const basketValue = currentQuestion.baskets[index];
            selectedBasket = basketValue;

            const btn1 = document.getElementById('basketBtn1');
            const btn2 = document.getElementById('basketBtn2');
            btn1.classList.add('disabled');
            btn2.classList.add('disabled');
            if (index === 0) btn1.classList.add('selected');
            else btn2.classList.add('selected');

            if (basketValue === currentQuestion.answer) {
                setRabbitEmotion('happy');
                showResult(true);
                setTimeout(() => {
                    correctCount++;
                    if (correctCount >= TOTAL_QUESTIONS) {
                        location.href = 'complete.html';
                    } else {
                        currentQuestion = generateQuestion();
                        selectedBasket = null;
                        setRabbitEmotion('curious');
                        updateUI();
                    }
                }, 1500);
            } else {
                setRabbitEmotion('sad');
                showResult(false);

                if (!firstWrongShown) {
                    // ì²« ì˜¤ë‹µ: ê²©ë ¤ í™”ë©´ í‘œì‹œ
                    firstWrongShown = true;
                    setTimeout(() => {
                        showEncourageOverlay();
                    }, 800);
                } else {
                    // ì´í›„ ì˜¤ë‹µ: ê¸°ì¡´ ë™ì‘
                    setTimeout(() => {
                        setRabbitEmotion('curious');
                        selectedBasket = null;
                        btn1.classList.remove('selected', 'disabled');
                        btn2.classList.remove('selected', 'disabled');
                    }, 1000);
                }
            }
        }

        window.addEventListener('load', () => {
            currentQuestion = generateQuestion();
            updateUI();
        });
    </script>
</body>
</html>
